if(!window.Readium)window.Readium={Models:{},Collections:{},Views:{},Routers:{},Utils:{},Init:function(){}};
Readium.Utils.MD5=function(e){function h(a,b){var c,d,e,f,g;e=a&2147483648;f=b&2147483648;c=a&1073741824;d=b&1073741824;g=(a&1073741823)+(b&1073741823);return c&d?g^2147483648^e^f:c|d?g&1073741824?g^3221225472^e^f:g^1073741824^e^f:g^e^f}function i(a,b,c,d,e,f,g){a=h(a,h(h(b&c|~b&d,e),g));return h(a<<f|a>>>32-f,b)}function j(a,b,c,d,e,f,g){a=h(a,h(h(b&d|c&~d,e),g));return h(a<<f|a>>>32-f,b)}function k(a,b,d,c,e,f,g){a=h(a,h(h(b^d^c,e),g));return h(a<<f|a>>>32-f,b)}function l(a,b,d,c,e,f,g){a=h(a,h(h(d^
(b|~c),e),g));return h(a<<f|a>>>32-f,b)}function m(a){var b="",d="",c;for(c=0;c<=3;c++)d=a>>>c*8&255,d="0"+d.toString(16),b+=d.substr(d.length-2,2);return b}var f=[],n,o,p,q,a,b,c,d,e=function(a){for(var a=a.replace(/\r\n/g,"\n"),b="",d=0;d<a.length;d++){var c=a.charCodeAt(d);c<128?b+=String.fromCharCode(c):(c>127&&c<2048?b+=String.fromCharCode(c>>6|192):(b+=String.fromCharCode(c>>12|224),b+=String.fromCharCode(c>>6&63|128)),b+=String.fromCharCode(c&63|128))}return b}(e),f=function(a){var b,c=a.length;
b=c+8;for(var d=((b-b%64)/64+1)*16,e=Array(d-1),f=0,g=0;g<c;)b=(g-g%4)/4,f=g%4*8,e[b]|=a.charCodeAt(g)<<f,g++;e[(g-g%4)/4]|=128<<g%4*8;e[d-2]=c<<3;e[d-1]=c>>>29;return e}(e);a=1732584193;b=4023233417;c=2562383102;d=271733878;for(e=0;e<f.length;e+=16)n=a,o=b,p=c,q=d,a=i(a,b,c,d,f[e+0],7,3614090360),d=i(d,a,b,c,f[e+1],12,3905402710),c=i(c,d,a,b,f[e+2],17,606105819),b=i(b,c,d,a,f[e+3],22,3250441966),a=i(a,b,c,d,f[e+4],7,4118548399),d=i(d,a,b,c,f[e+5],12,1200080426),c=i(c,d,a,b,f[e+6],17,2821735955),
b=i(b,c,d,a,f[e+7],22,4249261313),a=i(a,b,c,d,f[e+8],7,1770035416),d=i(d,a,b,c,f[e+9],12,2336552879),c=i(c,d,a,b,f[e+10],17,4294925233),b=i(b,c,d,a,f[e+11],22,2304563134),a=i(a,b,c,d,f[e+12],7,1804603682),d=i(d,a,b,c,f[e+13],12,4254626195),c=i(c,d,a,b,f[e+14],17,2792965006),b=i(b,c,d,a,f[e+15],22,1236535329),a=j(a,b,c,d,f[e+1],5,4129170786),d=j(d,a,b,c,f[e+6],9,3225465664),c=j(c,d,a,b,f[e+11],14,643717713),b=j(b,c,d,a,f[e+0],20,3921069994),a=j(a,b,c,d,f[e+5],5,3593408605),d=j(d,a,b,c,f[e+10],9,38016083),
c=j(c,d,a,b,f[e+15],14,3634488961),b=j(b,c,d,a,f[e+4],20,3889429448),a=j(a,b,c,d,f[e+9],5,568446438),d=j(d,a,b,c,f[e+14],9,3275163606),c=j(c,d,a,b,f[e+3],14,4107603335),b=j(b,c,d,a,f[e+8],20,1163531501),a=j(a,b,c,d,f[e+13],5,2850285829),d=j(d,a,b,c,f[e+2],9,4243563512),c=j(c,d,a,b,f[e+7],14,1735328473),b=j(b,c,d,a,f[e+12],20,2368359562),a=k(a,b,c,d,f[e+5],4,4294588738),d=k(d,a,b,c,f[e+8],11,2272392833),c=k(c,d,a,b,f[e+11],16,1839030562),b=k(b,c,d,a,f[e+14],23,4259657740),a=k(a,b,c,d,f[e+1],4,2763975236),
d=k(d,a,b,c,f[e+4],11,1272893353),c=k(c,d,a,b,f[e+7],16,4139469664),b=k(b,c,d,a,f[e+10],23,3200236656),a=k(a,b,c,d,f[e+13],4,681279174),d=k(d,a,b,c,f[e+0],11,3936430074),c=k(c,d,a,b,f[e+3],16,3572445317),b=k(b,c,d,a,f[e+6],23,76029189),a=k(a,b,c,d,f[e+9],4,3654602809),d=k(d,a,b,c,f[e+12],11,3873151461),c=k(c,d,a,b,f[e+15],16,530742520),b=k(b,c,d,a,f[e+2],23,3299628645),a=l(a,b,c,d,f[e+0],6,4096336452),d=l(d,a,b,c,f[e+7],10,1126891415),c=l(c,d,a,b,f[e+14],15,2878612391),b=l(b,c,d,a,f[e+5],21,4237533241),
a=l(a,b,c,d,f[e+12],6,1700485571),d=l(d,a,b,c,f[e+3],10,2399980690),c=l(c,d,a,b,f[e+10],15,4293915773),b=l(b,c,d,a,f[e+1],21,2240044497),a=l(a,b,c,d,f[e+8],6,1873313359),d=l(d,a,b,c,f[e+15],10,4264355552),c=l(c,d,a,b,f[e+6],15,2734768916),b=l(b,c,d,a,f[e+13],21,1309151649),a=l(a,b,c,d,f[e+4],6,4149444226),d=l(d,a,b,c,f[e+11],10,3174756917),c=l(c,d,a,b,f[e+2],15,718787259),b=l(b,c,d,a,f[e+9],21,3951481745),a=h(a,n),b=h(b,o),c=h(c,p),d=h(d,q);return(m(a)+m(b)+m(c)+m(d)).toLowerCase()};
Readium.FileSystemApi=function(){var f,h=83886080,j=function(a){window.webkitRequestFileSystem(window.PERSITENT,h,function(b){f=b;a&&a(g)},d)},m=function(a){window.webkitStorageInfo.requestQuota(PERSISTENT,h,function(b){h=b;a(g)},function(b){console.log("Error",b);console.log("Exectution will not continue")})},d=function(a){var b="";switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:b="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:b="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:b="SECURITY_ERR";
break;case FileError.INVALID_MODIFICATION_ERR:b="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:b="INVALID_STATE_ERR";break;default:b="Unknown Error"}console.log("Error: "+b)},k=function(a,b){if(b[0]=="."||b[0]=="")b=b.slice(1);a.getDirectory(b[0],{create:!0},function(a){b.length&&k(a,b.slice(1))},d)},n=function(a,b,c,i,e){c.getFile(a,{create:!0,exclusive:!1},function(a){a.createWriter(function(a){var c;a.onwriteend=function(a){i(a)};a.onerror=function(a){e(a)};if(b.webkitRelativePath||
b.relativePath){var d=new FileReader;d.onload=function(b){c=new WebKitBlobBuilder;c.append(b.target.result);a.write(c.getBlob())};d.readAsArrayBuffer(b)}else c=new WebKitBlobBuilder,typeof b==="string"?(c.append(b),a.write(c.getBlob("text/plain"))):(d=new Uint8Array(b),c.append(d.buffer),a.write(c.getBlob()))},e)},e)},l=function(a,b,c,d,e){if(a[0]==="."||a[0]==="")a=a.slice(1);a.length===1?n(a[0],b,c,d,e):c.getDirectory(a[0],{create:!0},function(c){a=a.slice(1);l(a,b,c,d,e)},e)},g={writeFile:function(a,
b,c,d){a=a.split("/");l(a,b,f.root,c,d)},getFileSystem:function(){return f},readEntry:function(a,b,c){a.file(function(d){var e=new FileReader;e.onloadend=function(){this.result?b(this.result,a):c&&c()};e.readAsText(d)},c||d)},readTextFile:function(a,b,c){var i=this;f.root.getFile(a,{},function(a){i.readEntry(a,b,c)},c||d)},rmdir:function(a){f.root.getDirectory(a,{},function(a){a.removeRecursively(function(){console.log("Directory removed.")},d)},d)},getFsUri:function(a,b,c){f.root.getFile(a,{create:!0,
exclusive:!1},function(a){b(a.toURL())},c||d)},mkdir:k,genericFsErrorHandler:d};return function(a){if(f)return a(g),g;webkitStorageInfo.queryUsageAndQuota(webkitStorageInfo.PERSITENT,function(b,c){c>0?j(a):m(function(){j(a)})})}}();
BBFileSystemSync=function(a,b,c){if(!b.file_path)throw"Cannot sync the model to the fs without a path";switch(a){case "read":Readium.FileSystemApi(function(a){a.readTextFile(b.file_path,function(a){c.success(a)},function(a){c.error(a)})});break;case "create":throw"Not yet implemented";case "update":throw"Not yet implemented";case "delete":throw"Not yet implemented";}return null};
Readium.Utils.Guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var b=Math.random()*16|0;return(d=="x"?b:b&3|8).toString(16)})};
Readium.Utils.LocalStorageAdaptor=function(d){var b,f=function(){localStorage.setItem(d,JSON.stringify(b))};return function(h,a,e){var c,g=localStorage.getItem(d);b=g&&JSON.parse(g)||{};switch(h){case "read":c=a.id?b[a.id]:_.values(b);break;case "create":if(!a.id)a.id=a.attributes.id=guid();b[a.id]=a;f();c=a;break;case "update":b[a.id]=a;f();c=a;break;case "delete":delete b[a.id],f(),c=a}c?e.success&&e.success(c):e.error&&e.error("Record not found")}};
window.resolveLocalFileSystemURL=window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL;window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder;function PathResolver(a){this.baseUrl=new URI(a)}PathResolver.prototype.resolve=function(a){return(new URI(a)).resolve(this.baseUrl)};
var domToString=function(a){return(new XMLSerializer).serializeToString(a)},fixCssLinks=function(a,d){var a=a.replace(/@import\s+(?:url\()*(.+?)(?:\))*\s*;/g,"@import url($1);"),b=/url\s*\(\s*['"]*\s*/,c=/['"]*\s*\)/;return a.replace(/url\s*\(\s*.+?\s*\)/g,function(a){a=a.replace(b,"");a=a.replace(c,"");return"url('"+d.resolve(a)+"')"})},fixXhtmlLinks=function(a,d){var b,c,f=(new window.DOMParser).parseFromString(a,"text/xml"),e=function(a){$("["+a+"]",f).each(function(){b=$(this);c=b.attr(a);c=d.resolve(c);
b.attr(a,c)})};e("src");e("href");$("image",f).each(function(){b=$(this);c=b.attr("xlink:href");c=d.resolve(c);b.attr("xlink:href",c)});return domToString(f)},getLinkFixingStrategy=function(a){return a.substr(-4)===".css"?fixCssLinks:a.substr(-5)===".html"||a.substr(-6)===".xhtml"?fixXhtmlLinks:a.substr(-4)===".xml"?fixXhtmlLinks:null},monkeyPatchUrls=function(a,d,b){var c,f=new PathResolver(a),e=getLinkFixingStrategy(a);if(e===null)d();else{var g=function(a){a=e(a,f);writeEntry(c,a,d,b)};window.resolveLocalFileSystemURL(a,
function(a){c=a;readEntry(c,g,b)})}},readEntry=function(a,d,b){a.file(function(a){var b=new FileReader;b.onloadend=function(){d(this.result)};b.readAsText(a)},b)},writeEntry=function(a,d,b,c){a.createWriter(function(a){a.onwriteend=function(){b()};a.onerror=function(a){c(a)};var e=new BlobBuilder;e.append(d);a.write(e.getBlob("text/plain"))},c)};
Readium.Models.ReadiumOptions=Backbone.Model.extend({initialize:function(){this.set("id","singleton")},defaults:{hijack_epub_urls:!1,verbose_unpacking:!0,paginate_everything:!0},sync:Readium.Utils.LocalStorageAdaptor("READIUM_OPTIONS")},{getInstance:function(){var a=new Readium.Models.ReadiumOptions;a.fetch({error:function(){localStorage.setItem("READIUM_OPTIONS","");a.save()}});return a}});
Readium.FileSystemApi=function(){var f,h=83886080,j=function(a){window.webkitRequestFileSystem(window.PERSITENT,h,function(b){f=b;a&&a(g)},d)},m=function(a){window.webkitStorageInfo.requestQuota(PERSISTENT,h,function(b){h=b;a(g)},function(b){console.log("Error",b);console.log("Exectution will not continue")})},d=function(a){var b="";switch(a.code){case FileError.QUOTA_EXCEEDED_ERR:b="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:b="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:b="SECURITY_ERR";
break;case FileError.INVALID_MODIFICATION_ERR:b="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:b="INVALID_STATE_ERR";break;default:b="Unknown Error"}console.log("Error: "+b)},k=function(a,b){if(b[0]=="."||b[0]=="")b=b.slice(1);a.getDirectory(b[0],{create:!0},function(a){b.length&&k(a,b.slice(1))},d)},n=function(a,b,c,i,e){c.getFile(a,{create:!0,exclusive:!1},function(a){a.createWriter(function(a){var c;a.onwriteend=function(a){i(a)};a.onerror=function(a){e(a)};if(b.webkitRelativePath||
b.relativePath){var d=new FileReader;d.onload=function(b){c=new WebKitBlobBuilder;c.append(b.target.result);a.write(c.getBlob())};d.readAsArrayBuffer(b)}else c=new WebKitBlobBuilder,typeof b==="string"?(c.append(b),a.write(c.getBlob("text/plain"))):(d=new Uint8Array(b),c.append(d.buffer),a.write(c.getBlob()))},e)},e)},l=function(a,b,c,d,e){if(a[0]==="."||a[0]==="")a=a.slice(1);a.length===1?n(a[0],b,c,d,e):c.getDirectory(a[0],{create:!0},function(c){a=a.slice(1);l(a,b,c,d,e)},e)},g={writeFile:function(a,
b,c,d){a=a.split("/");l(a,b,f.root,c,d)},getFileSystem:function(){return f},readEntry:function(a,b,c){a.file(function(d){var e=new FileReader;e.onloadend=function(){this.result?b(this.result,a):c&&c()};e.readAsText(d)},c||d)},readTextFile:function(a,b,c){var i=this;f.root.getFile(a,{},function(a){i.readEntry(a,b,c)},c||d)},rmdir:function(a){f.root.getDirectory(a,{},function(a){a.removeRecursively(function(){console.log("Directory removed.")},d)},d)},getFsUri:function(a,b,c){f.root.getFile(a,{create:!0,
exclusive:!1},function(a){b(a.toURL())},c||d)},mkdir:k,genericFsErrorHandler:d};return function(a){if(f)return a(g),g;webkitStorageInfo.queryUsageAndQuota(webkitStorageInfo.PERSITENT,function(b,c){c>0?j(a):m(function(){j(a)})})}}();
if(typeof Readium.FileSystemApi==="undefined")throw"ExtractBook holds Readium::FileSystemApi as a dependency";if(typeof Readium.Utils.MD5==="undefined")throw"Extract holds Readium::Utils::MD5 as a dependency";
Readium.Models.BookExtractorBase=Backbone.Model.extend({MIMETYPE:"mimetype",CONTAINER:"META-INF/container.xml",EPUB3_MIMETYPE:"application/epub+zip",DISPLAY_OPTIONS:"META-INF/com.apple.ibooks.display-options.xml",defaults:{task_size:100,progress:1,extracting:!1,log_message:"Fetching epub file"},clean:function(){this.removeHandlers();this.fsApi&&this.fsApi.rmdir(this.base_dir_name)},parseContainerRoot:function(a){var b=this.get("root_file_path");this.packageDoc=new Readium.Models.ValidatedPackageMetaData({key:this.base_dir_name,
src_url:this.get("src")},{file_path:this.base_dir_name+"/"+b,root_url:this.get("root_url")+"/"+b});this.packageDoc.reset(a);this.trigger("parsed:root_file")},writeFile:function(a,b,c){var d=this,e=this.base_dir_name+"/"+a;a.indexOf(this.DISPLAY_OPTIONS)>=0&&(typeof b==="string"?this.packageDoc.parseIbooksDisplayOptions(b):this.readEntryByShortName(this.DISPLAY_OPTIONS,function(a){d.packageDoc.parseIbooksDisplayOptions(a)}));this.fsApi.writeFile(e,b,c,function(){d.set("error","ERROR: while writing to filesystem")})},
parseMetaInfo:function(a){a=(new window.DOMParser).parseFromString(a,"text/xml").getElementsByTagName("rootfile");a.length!==1?this.set("error","Error processing "+CONTAINER):a[0].hasAttribute("full-path")?this.set("root_file_path",a[0].attributes["full-path"].value):this.set("error","Error: could not find package rootfile")},validateMimetype:function(a){$.trim(a)===this.EPUB3_MIMETYPE?this.trigger("validated:mime"):this.set("error","Invalid mimetype discovered. Progress cancelled.")},removeHandlers:function(){this.off()},
extraction_complete:function(){this.set("extracting",!1)},finish_extraction:function(){var a=this;this.set("log_message","Unpacking process completed successfully!");this.packageDoc.save({},{success:function(){a.trigger("extraction_success")},failure:function(){a.set("failure","ERROR: unkown problem durring unpacking process")}})},correctURIs:function(){var a=this.get("root_url"),b=this.get("patch_position"),c=this.get("manifest"),d=this;b===c.length?this.finish_extraction():(this.set("log_message",
"monkey patching: "+c[b]),monkeyPatchUrls(a+"/"+c[b],function(){d.set("patch_position",b+1)},function(){d.set("failure","ERROR: unkown problem durring unpacking process")}))}});
Readium.Models.ZipBookExtractor=Readium.Models.BookExtractorBase.extend({initialize:function(){var a=this.get("url");if(a)this.base_dir_name=Readium.Utils.MD5(a+(new Date).toString()),this.set("src",this.get("src_filename"));else throw"A URL to a zip file must be specified";},extractEntryByName:function(a,b){for(var c=!1,d=0;d<this.zip.entries.length;d++)if(this.zip.entries[d].name===a){c=!0;this.zip.entries[d].extract(b);break}if(!c)throw"asked to extract non-existent zip-entry: "+a;},extractContainerRoot:function(){var a=
this,b=this.get("root_file_path");try{this.extractEntryByName(b,function(b,c){a.parseContainerRoot(c)})}catch(c){this.set("error",c)}},extractMetaInfo:function(){var a=this;try{this.extractEntryByName(this.CONTAINER,function(b,d){a.parseMetaInfo(d)})}catch(b){this.set("error",b)}},extractMimetype:function(){var a=this;this.set("log_message","Verifying mimetype");try{this.extractEntryByName(this.MIMETYPE,function(b,d){a.validateMimetype(d)})}catch(b){this.set("error",b)}},validateZip:function(){var a=
this.zip.entryNames;this.set("log_message","Validating zip file");a.indexOf(this.MIMETYPE)>=0&&a.indexOf(this.CONTAINER)>=0?this.trigger("validated:zip"):this.set("error","File does not appear to be a valid EPUB. Progress cancelled.")},extractBook:function(){var a;a=this.zip;var b=this.get("zip_position"),c=this;b===a.entries.length?(this.set("log_message","All files unzipped successfully!"),this.set("patch_position",0)):(a=a.entries[b],a.name.substr(-1)==="/"?c.set("zip_position",b+1):(this.set("log_message",
"extracting: "+a.name),a.extract(function(a,e){c.writeFile(a.name,e,function(){c.set("zip_position",b+1)})})))},beginUnpacking:function(){for(var a=[],b,c=0;c<this.zip.entries.length;c++)b=this.zip.entries[c],b.name.substr(-1)!=="/"&&a.push(b.name);this.set("manifest",a);this.set("zip_position",0)},extract:function(){this.on("initialized:zip",this.validateZip,this);this.on("validated:zip",this.extractMimetype,this);this.on("validated:mime",this.extractMetaInfo,this);this.on("change:root_file_path",
this.extractContainerRoot,this);this.on("parsed:root_file",this.beginUnpacking,this);this.on("change:zip_position",this.extractBook,this);this.on("change:patch_position",this.correctURIs,this);this.on("change:failure",this.clean,this);this.on("change:failure",this.removeHandlers,this);this.on("change:task_size",this.update_progress,this);this.on("change:zip_position",this.update_progress,this);this.on("change:patch_position",this.update_progress,this);this.on("extraction_success",this.extraction_complete,
this);this.set("extracting",!0);var a=this;Readium.FileSystemApi(function(b){a.fsApi=b;a.initializeZip()})},update_progress:function(){var a=this.get("zip_position")||0,b=this.get("patch_position")||0;this.set("progress",Math.floor((a+b+3)*100/this.get("task_size")))},initializeZip:function(){var a=this;this.fsApi.getFileSystem().root.getDirectory(this.base_dir_name,{create:!0},function(b){a.set("root_url",b.toURL());a.zip=new ZipFile(a.get("url"),function(){a.set("task_size",a.zip.entries.length*
2+3);a.trigger("initialized:zip")},0)},function(){console.log("In beginUnpacking error handler. Does the root dir already exist?")})}});
Readium.Models.UnpackedBookExtractor=Readium.Models.BookExtractorBase.extend({initialize:function(){var a=this.get("dir_picker"),b=[],c;this.fNameStartInd=a.files[0].webkitRelativePath.indexOf("/")+1;this.base_dir_name=Readium.Utils.MD5("Banana"+(new Date).toString());this.fileList=a.files;for(a=0;c=this.fileList[a];++a)c=c.webkitRelativePath,c.substr(-2)!=="/."&&b.push(this.getShortName(c));this.set("src","Local Directory: "+this.fileList[0].webkitRelativePath.substring(0,this.fNameStartInd));this.set("task_size",
b.length*2+3);this.set("manifest",b)},getShortName:function(a){return a.substr(this.fNameStartInd)},update_progress:function(){var a=this.get("write_position")||0,b=this.get("patch_position")||0;this.set("progress",3+a+b)},extract:function(){this.on("validated:dir",this.readMime,this);this.on("validated:mime",this.readMetaInfo,this);this.on("change:root_file_path",this.readContainerRoot,this);this.on("parsed:root_file",this.beginWriting,this);this.on("change:write_position",this.writeEntry,this);
this.on("change:patch_position",this.correctURIs,this);this.on("change:failure",this.clean,this);this.on("change:failure",this.removeHandlers,this);this.on("change:task_size",this.update_progress,this);this.on("change:write_position",this.update_progress,this);this.on("change:patch_position",this.update_progress,this);this.on("extraction_success",this.extraction_complete,this);this.set("extracting",!0);var a=this;Readium.FileSystemApi(function(b){a.fsApi=b;b.getFileSystem().root.getDirectory(a.base_dir_name,
{create:!0},function(b){a.set("root_url",b.toURL());a.validateDir()})})},validateDir:function(){var a=this.get("manifest");a.indexOf(this.MIMETYPE)>=0&&a.indexOf(this.CONTAINER)>=0?this.trigger("validated:dir"):this.set("error","the directory you selected was not valid")},readMime:function(){var a=this;this.set("log_message","Verifying mimetype");try{this.readEntryByShortName(this.MIMETYPE,function(b){a.validateMimetype(b)})}catch(b){this.set("error",b)}},readMetaInfo:function(){var a=this;try{this.readEntryByShortName(this.CONTAINER,
function(b){a.parseMetaInfo(b)})}catch(b){this.set("error",b)}},readContainerRoot:function(){var a=this,b=this.get("root_file_path");try{this.readEntryByShortName(b,function(b){a.parseContainerRoot(b)})}catch(c){this.set("error",c)}},beginWriting:function(){this.set("write_position",0)},writeEntry:function(){var a=this,b=this.get("write_position");if(b===this.fileList.length)this.set("patch_position",0);else{var c=this.fileList[b],d=this.getShortName(c.webkitRelativePath);this.set("log_message","writing: "+
d);d.substr(-2)==="/."?this.set("write_position",b+1):this.writeFile(d,c,function(){a.set("write_position",b+1)})}},readEntryByShortName:function(a,b){for(var c=!1,d=this.get("dir_picker").files,e=0;e<d.length;e++)if(this.getShortName(d[e].webkitRelativePath)===a){var c=!0,f=new FileReader;f.onload=function(a){b(a.target.result)};f.readAsText(d[e]);break}if(!c)throw"asked to read non-existent file: "+a;}});
Readium.Utils.setCookie=function(e,a,b){var c=new Date;c.setDate(c.getDate()+b);a=escape(a)+(b==null?"":"; expires="+c.toUTCString());document.cookie=e+"="+a};Readium.Utils.getCookie=function(e){var a,b,c,d=document.cookie.split(";");for(a=0;a<d.length;a++)if(b=d[a].substr(0,d[a].indexOf("=")),c=d[a].substr(d[a].indexOf("=")+1),b=b.replace(/^\s+|\s+$/g,""),b==e)return unescape(c)};
Readium.Models.ManifestItem=Backbone.Model.extend({});Readium.Collections.ManifestItems=Backbone.Collection.extend({model:Readium.Models.ManifestItem});
Readium.Models.PackageDocumentBase=Backbone.Model.extend({initialize:function(){this.url=this.get("url");this.file_path=this.get("url");this.uri_obj=new URI(this.url)},jath_template:{metadata:{id:"//def:metadata/dc:identifier",epub_version:"//def:package/@version",title:"//def:metadata/dc:title",author:"//def:metadata/dc:creator",publisher:"//def:metadata/dc:publisher",description:"//def:metadata/dc:description",rights:"//def:metadata/dc:rights",language:"//def:metadata/dc:language",pubdate:"//def:metadata/dc:date",
modified_date:"//def:metadata/def:meta[@property='dcterms:modified']",layout:"//def:metadata/def:meta[@property='rendition:layout']",spread:"//def:metadata/def:meta[@property='rendition:spread']",orientation:"//def:metadata/def:meta[@property='rendition:orientation']",ncx:"//def:spine/@toc"},manifest:["//def:item",{id:"@id",href:"@href",media_type:"@media-type",properties:"@properties"}],spine:["//def:itemref",{idref:"@idref",properties:"@properties"}],bindings:["//def:bindings/def:mediaType",{handler:"@handler",
media_type:"@media-type"}]},getCoverHref:function(a){var b,c;b=a.getElementsByTagName("manifest")[0];c=$('item[properties~="cover-image"]',b);if(c.length===1&&c.attr("href"))return c.attr("href");a=$('meta[name="cover"]',a);c=a.attr("content");if(a.length===1&&c&&(c=$('item[id="'+c+'"]',b),c.length===1&&c.attr("href")))return c.attr("href");c=$("#cover",b);return c.length===1&&c.attr("href")?c.attr("href"):null},parse:function(a){var b;typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,
"text/xml"));Jath.resolver=function(a){return{def:"http://www.idpf.org/2007/opf",dc:"http://purl.org/dc/elements/1.1/"}[a]};b=Jath.parse(this.jath_template,a);if(a=this.getCoverHref(a))b.metadata.cover_href=this.resolveUri(a);if(b.metadata.layout==="pre-paginated")b.metadata.fixed_layout=!0;b.manifest=new Readium.Collections.ManifestItems(b.manifest);return b},reset:function(a){this.set(this.parse(a))},resolveUri:function(a){uri=new URI(a);return uri.resolve(this.uri_obj).toString()}});
Readium.Models.ValidatedPackageMetaData=Readium.Models.PackageDocumentBase.extend({initialize:function(a,b){Readium.Models.PackageDocumentBase.prototype.initialize.call(this,a,b);this.set("package_doc_path",this.file_path)},validate:function(){},defaults:{fixed_layout:!1,open_to_spread:!1,cover_href:"/images/library/missing-cover-image.png",created_at:new Date,updated_at:new Date},parseIbooksDisplayOptions:function(a){var b=(new window.DOMParser).parseFromString(a,"text/xml"),a=b.getElementsByName("fixed-layout")[0],
b=b.getElementsByName("open-to-spread")[0];this.set({fixed_layout:a&&a.textContent.toLowerCase().trim()==="true",open_to_spread:b&&b.textContent.toLowerCase().trim()==="true"})},parse:function(a){return Readium.Models.PackageDocumentBase.prototype.parse.call(this,a).metadata},save:function(a,b){var c=this;this.set("updated_at",new Date);Lawnchair(function(){this.save(c.toJSON(),b.success)})}});
Readium.Models.PackageDocument=Readium.Models.PackageDocumentBase.extend({initialize:function(){Readium.Models.PackageDocumentBase.prototype.initialize.call(this);this.on("change:spine_position",this.onSpinePosChanged)},onSpinePosChanged:function(){this.get("spine_position")>=this.previous("spine_position")?this.trigger("increased:spine_position"):this.trigger("decreased:spine_position")},validate:function(a){if(!a.manifest&&!this.get("manifest"))return"ERROR: All ePUBs must have a manifest";var b=
a.spine||this.get("spine");if(!b)return"ERROR: All ePUBs must have a spine";if(a.spine_position<0||a.spine_position>=b.length)return"ERROR: invalid spine position"},defaults:{spine_position:0},getManifestItem:function(a){return this.getManifestItemById(this.get("spine")[a].idref)},getManifestItemById:function(a){return this.get("manifest").find(function(b){if(b.get("id")===a)return b})},currentSection:function(){return this.getManifestItem(this.get("spine_position"))},hasNextSection:function(){return this.get("spine_position")<
this.get("spine").length-1},hasPrevSection:function(){return this.get("spine_position")>0},goToNextSection:function(){this.set({spine_position:this.get("spine_position")+1})},goToPrevSection:function(){this.set({spine_position:this.get("spine_position")-1})},goToHref:function(a){var b=this.get("spine"),c=this.get("manifest").find(function(b){var c=b.get("href").match(/[\.\/]*(.*)/);if(a.indexOf(c[c.length-1],a.length-c[c.length-1].length)!==-1)return b});if(!c)return null;for(var c=c.get("id"),d=
0;d<b.length;++d)if(b[d].idref===c){this.set({spine_position:d});break}},getResolvedSpine:function(){for(var a=this.get("spine").length,b=[],c=0;c<a;c++)b.push(this.getManifestItem(c));return b},getTocItem:function(){var a=this.get("manifest"),b=this.get("metadata").ncx,c=a.find(function(a){return a.get("properties")==="nav"});return c?c:b&&b.length>0?a.find(function(a){return a.get("id")===b}):null}});
Readium.Models.EbookBase=Backbone.Model.extend({initialize:function(){var a=this,b=this.get("package_doc_path");this.packageDocument=new Readium.Models.PackageDocument({url:b});this.packageDocument.on("change:spine_position",this.spinePositionChangedHandler,this);this.packageDocument.on("change:spine",function(){a.packageDocument.set({spine_position:0},{silent:!0});a.set("has_toc",!!a.packageDocument.getTocItem())});this.packageDocument.fetch({dataType:"xml"});this.on("change:num_pages",this.adjustCurrentPage,
this)},defaults:{font_size:10,current_page:[1],num_pages:0,two_up:!1,full_screen:!1,toolbar_visible:!0,toc_visible:!1},toggleTwoUp:function(){var a=this.get("two_up"),b=this.get("current_page"),c=[];a?c[0]=b[0]===0?1:b[0]:b[0]%2===0?(c[0]=b[0],c[1]=b[0]+1):(c[0]=b[0]-1,c[1]=b[0]);this.set({two_up:!a,current_page:c})},toggleFullScreen:function(){this.set({full_screen:!this.get("full_screen")})},increaseFont:function(){this.set({font_size:this.get("font_size")+1})},decreaseFont:function(){this.set({font_size:this.get("font_size")-
1})},toggleToc:function(){this.set("toc_visible",!this.get("toc_visible"))},prevPage:function(){var a=this.get("current_page"),b=a[0]-1;a[0]<=1?this.packageDocument.goToPrevSection():this.get("two_up")?this.set("current_page",[b-1,b]):this.set("current_page",[b])},nextPage:function(){var a=this.get("current_page"),b=a[a.length-1]+1;if(a[a.length-1]>=this.get("num_pages"))this.packageDocument.goToNextSection();else return this.get("two_up")?this.set("current_page",[b,b+1]):this.set("current_page",
[b])},goToFirstPage:function(){this.get("two_up")?this.set("current_page",[0,1]):this.set("current_page",[1])},goToLastPage:function(){var a=this.get("num_pages");this.get("two_up")?this.set("current_page",[a-1,a]):this.set("current_page",[a])},savePosition:function(){Readium.Utils.setCookie(_properties.key,_packageDocument.getPosition(),365)},resolvePath:function(a){var b=this.packageDocument.file_path,a=a.indexOf("../")===0?a.substr(3):a,c=b.lastIndexOf("/");return b.substr(0,c)+"/"+a},adjustCurrentPage:function(){var a=
this.get("current_page"),b=this.get("num_pages");this.get("two_up");a[a.length-1]>b&&this.goToLastPage()},goToNextSection:function(){this.packageDocument.hasNextSection()&&this.packageDocument.goToNextSection()},goToPrevSection:function(){this.packageDocument.hasPrevSection()&&this.packageDocument.goToPrevSection()},getSectionText:function(a,b){var c=this.packageDocument.currentSection();Readium.FileSystemApi(function(d){d.readTextFile(resolvePath(c),a,b)})},goToHref:function(a){this.packageDocument.goToHref(a)},
changPageNumber:function(a){var b=this.get("current_page"),c=[],d=a-b[b.length-1];d>0&&(d=0);for(var e=0;e<b.length;e++)c[e]=b[e]+d;this.set({num_pages:a,current_page:c})},spinePositionChangedHandler:function(){var a=this,b=this.packageDocument.currentSection().get("href"),c=this.packageDocument.resolveUri(b),b=this.resolvePath(b);this.set("current_section_url",c);$.ajax({url:b,accept:"xml",cache:!0,success:function(b){a.set("current_content",b)},error:function(){alert("Error: unable to fetch spine item");
window.router.navigate("/",{silent:!0})}})},getToc:function(){var a=this.packageDocument.getTocItem();return a?Readium.Models.Toc.getToc(a,{file_path:this.resolvePath(a.get("href")),book:this}):null},goToPage:function(a){this.get("two_up")?a%2===0?this.set("current_page",[a,a+1]):this.set("current_page",[a-1,a]):this.set("current_page",[a])}});
Readium.Models.ReflowableEbook=Readium.Models.EbookBase.extend({isFixedLayout:!1,initialize:function(){Readium.Models.EbookBase.prototype.initialize.call(this)},CreatePaginator:function(){var a=localStorage.READIUM_OPTIONS;return(a&&JSON.parse(a)||{singleton:{}}).singleton.paginate_everything?new Readium.Views.ReflowablePaginationView({model:this}):new Readium.Views.ScrollingPaginationView({model:this})}});
Readium.Models.AppleFixedEbook=Readium.Models.EbookBase.extend({isFixedLayout:!0,defaults:{font_size:10,current_page:[0,1],num_pages:0,two_up:!1,full_screen:!1,toolbar_visible:!0},initialize:function(){Readium.Models.EbookBase.prototype.initialize.call(this);this.on("change:current_content",this.parseMetaTags,this)},CreatePaginator:function(){return new Readium.Views.FixedPaginationView({model:this})},buildSectionJSON:function(a){var b={};b.width=this.get("meta_width");b.height=this.get("meta_height");
b.uri=this.packageDocument.resolveUri(a.get("href"));return b},getAllSections:function(){for(var a=this.packageDocument.getResolvedSpine(),b=[],c=0;c<a.length;c++)b.push(this.buildSectionJSON(a[c]));return b},parseViewportTag:function(a){for(var a=a.getAttribute("content"),a=a.replace(/\s/g,""),a=a.split(","),b={},c,d=0;d<a.length;d++)c=a[d].split("="),c.length===2&&(b[c[0]]=c[1]);b.width=parseFloat(b.width);b.height=parseFloat(b.height);return b},parseMetaTags:function(){var a=this.get("current_content");
typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));if(a=$("meta[name]='viewport'",a)[0])a=this.parseViewportTag(a),this.set({meta_width:a.width,meta_height:a.height});this.packageDocument.off("change:spine_position");this.off("current_content");this.trigger("first_render_ready")},spinePositionChangedHandler:function(){Readium.Models.EbookBase.prototype.spinePositionChangedHandler.call(this);this.goToPage(this.packageDocument.get("spine_position"))}});
Readium.Models.Toc=Backbone.Model.extend({sync:BBFileSystemSync,initialize:function(a){this.file_path=a.file_path;this.book=a.book;this.book.on("change:toc_visible",this.setVisibility,this)},handleLink:function(a){this.book.goToHref(a)},setVisibility:function(){this.set("visible",this.book.get("toc_visible"))},defaults:{visible:!1}},{XHTML_MIME:"application/xhtml+xml",XML_MIME:"text/xml",NCX_MIME:"application/x-dtbncx+xml",getToc:function(a,b){var c=a.get("media_type");if(c===Readium.Models.Toc.XHTML_MIME||
c===Readium.Models.Toc.XML_MIME)return new Readium.Models.XhtmlToc(b);else if(c===Readium.Models.Toc.NCX_MIME)return new Readium.Models.NcxToc(b)}});
Readium.Models.NcxToc=Readium.Models.Toc.extend({jath_template:{title:"//ncx:docTitle/ncx:text",navs:["//ncx:navMap/ncx:navPoint",{text:"ncx:navLabel/ncx:text",href:"ncx:content/@src"}]},parse:function(a){typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));Jath.resolver=function(a){return a==="ncx"?"http://www.daisy.org/z3986/2005/ncx/":""};return Jath.parse(this.jath_template,a)},TocView:function(){return new Readium.Views.NcxTocView({model:this})}});
Readium.Models.XhtmlToc=Readium.Models.Toc.extend({parse:function(a){var b={};typeof a==="string"&&(a=(new window.DOMParser).parseFromString(a,"text/xml"));b.title=$("title",a).text();b.body=$("body",a);return b},TocView:function(){return new Readium.Views.XhtmlTocView({model:this})}});
Readium.Views.PaginationViewBase=Backbone.View.extend({el:"#readium-book-view-el",renderToLastPage:!1,initialize:function(){this.model.on("change:current_page",this.changePage,this);this.model.on("change:font_size",this.setFontSize,this);this.bindingTemplate=_.template($("#binding-template").html());this.model.packageDocument.on("increased:spine_position",function(){this.renderToLastPage=!1},this);this.model.packageDocument.on("decreased:spine_position",function(){this.renderToLastPage=!0},this)},
linkClickHandler:function(a){a.preventDefault();a=a.srcElement.attributes.href.value;a.match(/^http(s)?:/)?chrome.tabs.create({url:a}):this.model.goToHref(a)},getBindings:function(){var a=this.model.packageDocument;return a.get("bindings").map(function(b){b.selector='object[type="'+b.media_type+'"]';b.url=a.getManifestItemById(b.handler).get("href");b.url=a.resolveUri(b.url);return b})},applyBindings:function(a){for(var b=this,c=this.getBindings(),d=0,d=0;d<c.length;d++)$(c[d].selector,a).each(function(){var a=
[],f=$(this),e=f.attr("data");a.push("src="+b.model.packageDocument.resolveUri(e));a.push("type="+c[d].media_type);a=c[d].url+"?"+a.join("&");e=$(b.bindingTemplate({}));e.attr("src",a);f.html(e)})},applySwitches:function(a){var b=function(a){a=a.attributes["required-namespace"];return!a?(console.log("Encountered a case statement with no required-namespace"),!1):_.include(["http://www.w3.org/1998/Math/MathML"],a)};$("switch",a).each(function(){var a;a=$("case",this);a.each(function(){var a=$(this);
a.data("style",a.attr("style")||"");a.attr("style","display: none")});if(a=_.find(a,b))$(a).attr("style",$(a).data("style")),$("default",this).attr("style","display: none")})},addStyleSheets:function(a){var b,c;$(".readium-dynamic-sh").remove();$($("link",a).get().reverse()).each(function(){b=this;typeof b.rel==="string"&&b.rel.toUpperCase()==="STYLESHEET"&&(c=$(b),c.addClass("readium-dynamic-sh"),$("head").prepend(c))})},applyHidden:function(a){$("[hidden]",a).toggle(!1)},setUpMode:function(){var a=
this.model.get("two_up");this.$el.toggleClass("two-up",a);this.$("#spine-divider").toggle(a)},events:{"click #page-margin":function(){this.trigger("toggle_ui")},"click #readium-content-container a":function(a){this.linkClickHandler(a)}},isPageVisible:function(a,b){return b.indexOf(a)!==-1},changePage:function(){var a=this,b=this.model.get("current_page"),c=this.model.get("two_up");this.$(".page-wrap").each(function(d){c||(d+=1);$(this).toggleClass("hidden-page",!a.isPageVisible(d,b))})},appendContent:function(){alert("not implemented yet")},
replaceContent:function(a){this.$("#readium-content-container").css("visibility","hidden").html(a+"<div id='content-end'></div>");_contentEnd=$("#content-end")},toggleTwoUp:function(){},setFontSize:function(){var a=this.model.get("font_size")/10;$("#readium-content-container").css("font-size",a+"em");this.renderPages()},injectMathJax:function(a){var a=a.contentDocument,b=a.createElement("script");b.type="text/javascript";b.src=MathJax.Hub.config.root+"/MathJax.js?config=readium-iframe";a.getElementsByTagName("head")[0].appendChild(b)}});
Readium.Views.ScrollingPaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(){Readium.Views.PaginationViewBase.prototype.initialize.call(this);this.page_template=_.template($("#scrolling-page-template").html());this.model.on("change:current_section_url",this.render,this)},render:function(){var a=this,b=this.model.get("current_section_url");this.$("#container").html(this.page_template({uri:b}));this.$(".content-sandbox").on("load",function(b){a.applyBindings($(b.srcElement).contents());
a.applySwitches(b.srcElement);a.injectMathJax(b.srcElement);a.injectLinkHandler(b.srcElement)});return this},injectLinkHandler:function(a){$("a",a.contentDocument).click(this.linkClickHandler,this)}});
Readium.Views.ReflowablePaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(){Readium.Views.PaginationViewBase.prototype.initialize.call(this);this.page_template=_.template($("#reflowing-page-template").html());this.model.on("repagination_event",this.renderPages,this);this.model.on("change:current_content",this.render,this);this.model.on("change:two_up",this.renderPages,this)},render:function(){var a=this.model.get("current_content"),a=typeof a==="string"?(new window.DOMParser).parseFromString(a,
"text/xml"):a;this.addStyleSheets(a);this.applyBindings(a);this.applySwitches(a);this.replaceContent(a.body.innerHTML);this.$("#container").html(this.page_template({page_num:1,empty:!1}));var b=this;MathJax.Hub.Queue(["Delay",MathJax.Callback,8],["Typeset",MathJax.Hub],function(){b.renderPages();b.toggleTwoUp();b.renderToLastPage?b.model.goToLastPage():b.model.goToFirstPage()});return this},guessPageNumber:function(){var a;a=$("#readium-content-container").height()/$(".page").first().height();return a<
1?1:Math.ceil(a)},needsMorePages:function(){var a=function(a){return a.outerHeight(!0)+a.offset().top},b=a(this.$(".page").last()),a=a($("#content-end"));return b<a},renderPages:function(){var a,b,c,d=this.model.get("two_up");c=this.guessPageNumber();b="";this.setUpMode();d&&(b+=this.page_template({page_num:0,empty:!0}));for(a=1;a<=c;a++)b+=this.page_template({page_num:a,empty:!1});for(this.$("#container").html(b);this.needsMorePages();)this.$("#container").append(this.page_template({page_num:a,empty:!1})),
a+=1;d&&c%2===0&&(c+=1,this.$("#container").append(this.page_template({page_num:a,empty:!1})));this.model.changPageNumber(c);this.$("#readium-content-container").css("visibility","visible");Modernizr.regions||$("#readium-content-container").regions(".page");this.changePage()}});
Readium.Views.FixedPaginationView=Readium.Views.PaginationViewBase.extend({initialize:function(){this.page_template=_.template($("#fixed-page-template").html());this.empty_template=_.template($("#empty-fixed-page-template").html());Readium.Views.PaginationViewBase.prototype.initialize.call(this);this.model.on("first_render_ready",this.render,this);this.model.on("change:two_up",this.setUpMode,this)},render:function(){var a=this.model.getAllSections();$("body").addClass("apple-fixed-layout");this.setUpMode();
this.$el.width(this.model.get("meta_width")*2);this.$el.height(this.model.get("meta_height"));for(var b=0;b<a.length;b++)a[b].page_num=b+1,this.$("#container").append(this.page_template(a[b]));var c=this;this.$(".content-sandbox").on("load",function(a){c.applyBindings($(a.srcElement).contents())});this.model.changPageNumber(b);setTimeout(function(){$("#page-wrap").zoomAndScale()},10);return this.renderPages()},setUpMode:function(){Readium.Views.PaginationViewBase.prototype.setUpMode.call(this);var a=
this.model.get("two_up"),b=this.model.get("meta_height"),c=this.model.get("meta_width");a?this.empty_template({page_num:0,height:b,width:c}):$("#page-0").remove()},renderPages:function(){this.changePage();return this},changePage:function(){var a=this,b=this.model.get("current_page");this.model.get("two_up");this.$(".fixed-page-wrap").each(function(c){$(this).toggle(a.isPageVisible(c+1,b))})},events:{"click #page-wrap a":function(a){this.linkClickHandler(a)}}});
Readium.Views.NavWidgetView=Backbone.View.extend({el:"#settings",initialize:function(){this.model.on("change:two_up",this.render,this);this.model.on("change:full_screen",this.render,this);setTimeout(function(){$("#settings").addClass("hover-fade")},1E3)},render:function(){var a=this.model;this.$("#to-fs-icon").toggle(!a.get("full_screen"));this.$("#from-fs-icon").toggle(a.get("full_screen"));this.$("#two-up-icon").toggle(!a.get("two_up"));this.$("#one-up-icon").toggle(a.get("two_up"))},events:{"click #show-toc-button":function(){this.model.toggleToc()},
"click #increase-font-button":function(){this.model.increaseFont()},"click #decrease-font-button":function(){this.model.decreaseFont()},"click #fullscreen-button":function(){this.model.toggleFullScreen()},"click #two-up-button":function(){this.model.toggleTwoUp()},"click #page-back-button":function(){this.model.prevPage()},"click #page-fwd-button":function(){this.model.nextPage()}}});
Readium.Views.ToolbarView=Backbone.View.extend({el:"#toolbar-el",initialize:function(){this.model.on("change:toolbar_visible",this.render,this)},render:function(){console.log("toolbar render called");this.$("#show-toolbar-button").toggle(!this.model.get("toolbar_visible"));this.$("#top-bar").toggle(this.model.get("toolbar_visible"));return this},events:{"click #hide-toolbar-button":"hide_toolbar","click #show-toolbar-button":"show_toolbar","click #back-to-lib-button":"show_library"},show_toolbar:function(){this.model.set("toolbar_visible",
!0)},hide_toolbar:function(){this.model.set("toolbar_visible",!1)},show_library:function(){window.router.navigate("/",{trigger:!0})}});
Readium.Views.TocViewBase=Backbone.View.extend({el:"#readium-toc",initialize:function(){this.model.on("change",this.render,this);this.model.on("change:visible",this.setVisibility,this)},events:{"click a":"handleClick"},setVisibility:function(){this.$el.toggle(this.model.get("visible"))},handleClick:function(a){a.preventDefault();href=$(a.target).attr("href");this.model.handleLink(href)}});
Readium.Views.NcxTocView=Readium.Views.TocViewBase.extend({initialize:function(){Readium.Views.TocViewBase.prototype.initialize.call(this);this.nav_template=_.template($("#ncx-nav-tempate").html())},render:function(){this.setVisibility();for(var a=$("<ol></ol>"),c=this.model.get("navs"),b=0;b<c.length;b++)a.append(this.nav_template(c[b]));this.$el.html("<h2>"+(this.model.get("title")||"Contents")+"</h2>");this.$el.append(a);return this}});
Readium.Views.XhtmlTocView=Readium.Views.TocViewBase.extend({render:function(){this.$el.html(this.model.get("body").html());return this}});
Readium.Views.ViewerApplicationView=Backbone.View.extend({el:"#readium-viewer-activity",uiVisible:!1,initialize:function(){this.model.on("change:full_screen",this.toggleFullscreen,this);this.paginator=this.model.CreatePaginator();this.paginator.on("toggle_ui",this.toggleUI,this);this.navWidget=new Readium.Views.NavWidgetView({model:_book});this.navWidget.render();this.toolbar=new Readium.Views.ToolbarView({model:_book});this.toolbar.render();this.model.on("change:has_toc",this.init_toc,this);this.addGlobalEventHandlers()},
toggleUI:function(){},toggleFullscreen:function(){this.model.get("full_screen")?document.documentElement.webkitRequestFullScreen():document.webkitCancelFullScreen()},addGlobalEventHandlers:function(){var a=this.model;window.onresize=function(){a.trigger("repagination_event")};$(document).keydown(function(b){b.which==39&&a.nextPage();b.which==37&&a.prevPage()});a.isFixedLayout?$("#touch-panel"):$(document);$(document).on("swipeleft",function(){a.nextPage()});$(document).on("swiperight",function(){a.prevPage()})},
render:function(){this.toggleUI();var a=this;setTimeout(function(){a.toggleUI()},2E3)},init_toc:function(){if(this.model.get("has_toc")){var a=this.model.getToc();this.toc=a.TocView();a.fetch()}}});
Readium.Models.LibraryItem=Backbone.Model.extend({idAttribute:"key",getViewBookUrl:function(){return"/view_book/"+this.get("key")},openInReader:function(){window.router.navigate(this.getViewBookUrl(),{trigger:!0})}});Readium.Collections.LibraryItems=Backbone.Collection.extend({model:Readium.Models.LibraryItem,url:"/epub_content/metadata.json"});
Readium.Views.LibraryItemView=Backbone.View.extend({tagName:"div",className:"book-item clearfix",initialize:function(){_.bindAll(this,"render");this.template=_.template($("#library-item-template").html())},render:function(){var a=this.template({data:this.model.toJSON()});$(this.el).html(a);return this},events:{"click .delete":function(a){a.preventDefault();var b="#details-modal-"+this.model.get("key"),a="Are you sure you want to perminantly delete ";a+=this.model.get("title");a+="?";confirm(a)&&($(b).modal("hide"),
this.model.destroy(),this.remove())},"click .read":function(){this.model.openInReader()}}});
Readium.Views.LibraryItemsView=Backbone.View.extend({tagName:"div",id:"library-items-container",className:"row-view clearfix",initialize:function(){this.template=_.template($("#library-items-template").html());this.collection.bind("reset",this.render,this);this.collection.bind("add",this.addOne,this)},render:function(){var a=this.collection,b=$(this.el);b.html(this.template({}));this.$("#empty-message").toggle(this.collection.isEmpty());a.each(function(c){c=new Readium.Views.LibraryItemView({model:c,
collection:a,id:c.get("id")});b.append(c.render().el)});$("#library-books-list").html(this.el);return this},addOne:function(a){a=new LibraryItemView({model:a,collection:this.collection,id:a.get("id")});this.$("#empty-message").toggle(!1);$(this.el).append(a.render().el)},events:{}});
Readium.Views.ExtractItemView=Backbone.View.extend({el:$("#progress-container")[0],initialize:function(){this.template=_.template($("#extracting-item-template").html());this.model.bind("change",this.render,this);this.model.bind("change:error",this.extractionFailed,this)},render:function(){var a=$(this.el);this.model.get("extracting")?(a.html(this.template(this.model.toJSON())),a.show("slow")):a.hide("slow");return this},extractionFailed:function(){alert(this.model.get("error"));this.model.set("extracting",
!1)}});
Readium.Views.ReadiumOptionsView=Backbone.View.extend({el:"#readium-options-modal",initialize:function(){this.model.on("change",this.render,this);this.render()},render:function(){var a=this.model;this.$("#paginate_everything").prop("checked",a.get("paginate_everything"));this.$("#verbose_unpacking").prop("checked",a.get("verbose_unpacking"));this.$("#hijack_epub_urls").prop("checked",a.get("hijack_epub_urls"))},events:{"change #verbose_unpacking":"updateSettings","change #hijack_epub_urls":"updateSettings","change #paginate_everything":"updateSettings",
"click #save-settings-btn":"save"},updateSettings:function(){var a=this.$("#hijack_epub_urls").prop("checked"),b=this.$("#verbose_unpacking").prop("checked"),c=this.$("#paginate_everything").prop("checked");this.model.set({verbose_unpacking:b,hijack_epub_urls:a,paginate_everything:c})},save:function(){this.model.save();this.$el.modal("hide")}});
Readium.Views.FilePickerView=Backbone.View.extend({el:"#add-book-modal",events:{"change #files":"handleFileSelect","change #dir_input":"handleDirSelect","click #url-button":"handleUrl"},show:function(){this.$el.modal("show")},hide:function(){this.$el.modal("hide")},resetForm:function(){},handleUrl:function(){var a=document.getElementById("book-url");a.value===null||a.value.length<1?alert("invalid url, cannot process"):(a=a.value,this.beginExtraction(new Readium.Models.ZipBookExtractor({url:a,src_filename:a})))},
handleFileSelect:function(a){var a=a.target.files,b=window.webkitURL.createObjectURL(a[0]);this.beginExtraction(new Readium.Models.ZipBookExtractor({url:b,src_filename:a[0].name}))},handleDirSelect:function(a){this.beginExtraction(new Readium.Models.UnpackedBookExtractor({dir_picker:a.target}))},beginExtraction:function(a){window.extract_view=new ExtractItemView({model:a});a.on("extraction_success",function(){var b=a.packageDoc.toJSON();window.Library.add(new window.LibraryItem(b));setTimeout(function(){chrome.tabs.create({url:"/views/viewer.html?book="+
b.key})},800)});a.extract();this.resetForm();this.hide()}});
Readium.Routers.ApplicationRouter=Backbone.Router.extend({initialize:function(a){this.collection=a.collection},routes:{"view_book/:id":"openBook","":"showLibrary"},openBook:function(a){this.showViewer();a=this.collection.get(a).toJSON();a.fixed_layout?(console.log("initializing fixed layout book"),window._book=new Readium.Models.AppleFixedEbook(a)):(console.log("initializing reflowable book"),window._book=new Readium.Models.ReflowableEbook(a));window._libraryView=new Readium.Views.ViewerApplicationView({model:window._book});
window._libraryView.render()},showLibrary:function(){$("#readium-library-activity").toggle(!0);$("#readium-viewer-activity").toggle(!1)},showViewer:function(){$("#readium-library-activity").toggle(!1);$("#readium-viewer-activity").toggle(!0)},splat_handler:function(a){console.log(a)}});
$(document).on("pageinit",function(){window.options=Readium.Models.ReadiumOptions.getInstance();window.optionsView=new Readium.Views.ReadiumOptionsView({model:window.options});window.Library=new Readium.Collections.LibraryItems(window.ReadiumLibraryData);window.lib_view=new Readium.Views.LibraryItemsView({collection:window.Library});window.fp_view=new Readium.Views.FilePickerView;window.router=new Readium.Routers.ApplicationRouter({collection:window.Library});Backbone.history.start({pushState:!1});
window.Library.trigger("reset");$("#block-view-btn").click(function(){$("#library-items-container").addClass("block-view").removeClass("row-view")});$("#row-view-btn").click(function(){$("#library-items-container").addClass("row-view").removeClass("block-view")})});
